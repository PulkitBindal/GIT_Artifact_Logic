name: W2

on:
  push:
    branches:
      - main
env:
  OWNER: PulkitBindal
  REPO: GIT_Artifact_Logic
jobs:
  normal_job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Run Bash Script
        id: run_script
        run: |
          #!/bin/bash
          OWNER="PulkitBindal"
          REPO="GIT_Artifact_Logic"
          
          latest_run_url=$(curl -s -H "Authorization: Bearer ${{ secrets.ARTIFACTLOGIC }}" "https://api.github.com/repos/$OWNER/$REPO/actions/workflows/W1.yaml/runs?per_page=1" | jq -r '.workflow_runs[0].url')
          
          if [ -z "$latest_run_url" ]; then
              echo "No runs found for workflow W1.yaml"
              exists="False"
              exit 0
          fi
          
          artifacts_url="${latest_run_url}/artifacts"
          artifacts_response=$(curl -s -H "Authorization: Bearer ${{ secrets.ARTIFACTLOGIC }}" "$artifacts_url")
          
          if [ "$(echo "$artifacts_response" | jq '.total_count')" -gt 0 ]; then
              latest_artifact_name=$(echo "$artifacts_response" | jq -r '.artifacts[0].name')
              echo "$latest_artifact_name"
              exists="True"
          else
              echo "No artifacts found for the latest run of workflow W1.yaml"
              exists="False"
          fi
          
          echo "exists=$exists" >> $GITHUB_ENV

      - name: Printing Results of Previous Artifact
        run: |
         echo "$exists"
         echo "${{ env.exists}}"
         
  conditional_job_1:
    runs-on: ubuntu-latest
    if: ${{ env.exists != 'True' }}
    needs: normal_job
    steps:
      - name: Conditional Step
        run: |
          OWNER="${{ env.OWNER }}"
          REPO="${{ env.REPO }}"
          curl -L -X POST -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.ARTIFACTLOGIC }}" -H "X-GitHub-Api-Version: 2022-11-28" https://api.github.com/repos/$OWNER/$REPO/actions/workflows/W1.yaml/dispatches -d '{"ref":"main"}'
          
  conditional_job_2:
    runs-on: ubuntu-latest
    needs: normal_job
    steps:
      - name: Hold
        uses: jakejarvis/wait-action@master
        with:
         time: '20s'

      - name: Run Bash Script for the second time
        id: run_script
        run: |
          #!/bin/bash
          OWNER="PulkitBindal"
          REPO="GIT_Artifact_Logic"
          
          latest_run_url=$(curl -s -H "Authorization: Bearer ${{ secrets.ARTIFACTLOGIC }}" "https://api.github.com/repos/$OWNER/$REPO/actions/workflows/W1.yaml/runs?per_page=1" | jq -r '.workflow_runs[0].url')
          
          if [ -z "$latest_run_url" ]; then
              echo "No runs found for workflow W1.yaml"
              exists="False"
              exit 0
          fi
          
          artifacts_url="${latest_run_url}/artifacts"
          artifacts_response=$(curl -s -H "Authorization: Bearer ${{ secrets.ARTIFACTLOGIC }}" "$artifacts_url")
          
          if [ "$(echo "$artifacts_response" | jq '.total_count')" -gt 0 ]; then
              latest_artifact_name=$(echo "$artifacts_response" | jq -r '.artifacts[0].name')
              echo "$latest_artifact_name"
              exists="True"
          else
              echo "No artifacts found for the latest run of workflow W1.yaml"
              exists="False"
          fi
          
          echo "exists=$exists" >> $GITHUB_ENV

      # - name: Downloading the artifact
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: steven
      #     github-token: ${{ secrets.ARTIFACTLOGIC }}
      #     repository: $OWNER/$REPO
      # - name: Download multiple artifacts
      #   uses: marcofaggian/action-download-multiple-artifacts@v4.0.1
      #   with:
      #     names: steven
      #     paths: .
      #     github_token: ${{secrets.ARTIFACTLOGIC}}
      #     workflow: W1.yaml
          
      - name: Download artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          name: steven
          github_token: ${{secrets.ARTIFACTLOGIC}}
          workflow: W1.yaml
          if_no_artifact_found: warn


      - name: Display structure of downloaded files
        run: ls -lrt
